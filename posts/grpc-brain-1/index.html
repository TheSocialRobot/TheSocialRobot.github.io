<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="How to use bi-directional gRPC in go" /><meta property="og:locale" content="en" /><meta name="description" content="Most robots don’t have a great deal on on-board processing power and so when we considered the basic architecture of The Social Robot it was clear we need to offload as much work as we can. In the first architecture post I settled on using gRPC as the main brain-body transport. It’s now time to start building out the brain and body code and the communication between these components." /><meta property="og:description" content="Most robots don’t have a great deal on on-board processing power and so when we considered the basic architecture of The Social Robot it was clear we need to offload as much work as we can. In the first architecture post I settled on using gRPC as the main brain-body transport. It’s now time to start building out the brain and body code and the communication between these components." /><link rel="canonical" href="https://www.thesocialrobot.org/posts/grpc-brain-1/" /><meta property="og:url" content="https://www.thesocialrobot.org/posts/grpc-brain-1/" /><meta property="og:site_name" content="The Social Robot" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-11T14:23:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="How to use bi-directional gRPC in go" /><meta name="twitter:site" content="@davesnowdon" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-09-11T14:23:00+01:00","datePublished":"2022-09-11T14:23:00+01:00","description":"Most robots don’t have a great deal on on-board processing power and so when we considered the basic architecture of The Social Robot it was clear we need to offload as much work as we can. In the first architecture post I settled on using gRPC as the main brain-body transport. It’s now time to start building out the brain and body code and the communication between these components.","headline":"How to use bi-directional gRPC in go","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.thesocialrobot.org/posts/grpc-brain-1/"},"url":"https://www.thesocialrobot.org/posts/grpc-brain-1/"}</script><title>How to use bi-directional gRPC in go | The Social Robot</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="The Social Robot"><meta name="application-name" content="The Social Robot"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">The Social Robot</a></div><div class="site-subtitle font-italic">An embodied robot companion</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/TheSocialRobot" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/davesnowdon" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['hello','thesocialrobot.org'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>How to use bi-directional gRPC in go</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>How to use bi-directional gRPC in go</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/davesnowdon">Dave Snowdon</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1662902580" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-09-11 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2824 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p>Most robots don’t have a great deal on on-board processing power and so when we considered the <a href="https://www.thesocialrobot.org/posts/basic-architecture/">basic architecture</a> of The Social Robot it was clear we need to offload as much work as we can. In the first architecture post I settled on using <a href="https://grpc.io/">gRPC</a> as the main brain-body transport. It’s now time to start building out the brain and body code and the communication between these components.</p><p>In order to keep the length manageable this article will implement the simplest possible server and a “fake body” client. The following articles will add authentication and build clients that run on the actual robots.</p><p>You can find all the code discussed here in <a href="https://github.com/TheSocialRobot/BrainCore/pull/2">this pull request</a>.</p><h2 id="what-is-grpc"><span class="mr-2">What is gRPC?</span><a href="#what-is-grpc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you’ve been working on web services exposing <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST</a> or <a href="https://graphql.org/">GraphQL</a> endpoints then gRPC may seem a little strange to you, so before getting down to code let’s see what gRPC is and how it differs from other web technologies. The “g” in “gRPC” stands for “Google” - gRPC is an open-source framework from Google that is designed to improve upon and replace a Google-internal framework. The “RPC” stands for “Remote Procedure Call” - the idea is that you can write code that invokes functions that execute not on the machine running the rest of your program but a <em>remote</em> machine via a network connection. “Procedure” is not a very common term these days and originates from languages such as Pascal (and possibly older ones, I’m not sure), but you can just think of it as equivalent to “function”.</p><p>Before REST became the most common way to build web-services, various flavours of RPC were the normal way for services to interact. Originally companies built proprietary mechanisms such as <a href="https://www.wikiwand.com/en/Sun_RPC">Sun RPC</a>. Eventually standards bodies created frameworks suchs as <a href="https://en.wikipedia.org/wiki/Distributed_Computing_Environment">DCE</a> and <a href="https://en.wikipedia.org/wiki/Common_Object_Request_Broker_Architecture">CORBA</a> - these were fairly heavyweight systems and (if I remember correctly) awkward to set up, expensive or both. As the web became more popular standards such as <a href="https://en.wikipedia.org/wiki/XML-RPC">XML-RPC</a> and later <a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a> that used HTTP as the transport and <a href="https://en.wikipedia.org/wiki/XML">XML</a> to describe the content became more popular as these were much simpler and easier to get started with and people were comfortable exposing HTTP endpoints on the internet.</p><p>This may all be starting to sound like ancient history, so why is gRPC a thing? In two words: performance and efficiency. It’s very convenient to manipulate JSON data in a client running in a web browser but JSON encoded data is not very space efficient and can be relatively slow to parse. If you’re exchanging data between two services or your clients are not web browsers then it can be much faster and more space-efficient to use a binary encoding.</p><p>gRPC uses <a href="https://developers.google.com/protocol-buffers">protocol buffers</a> - commonly referred to as “protobuf” - to define a language neutral and platform neutral binary representation for the messages to be exchanged between a server and client. Tools are provide to read a protobuf file and generate code to serialise and de-serialise data in a variety of languages.</p><p>gRPC adds to a protobuf a network transport that takes advantage of modern web standards such as <a href="https://en.wikipedia.org/wiki/HTTP/2">HTTP/2</a>, and <a href="https://en.wikipedia.org/wiki/QUIC">QUIC</a> and provides mechanisms for encryption and authentication.</p><p>One of the cool things about gRPC (and the reason I decided to use it) is that it supports bi-directional streaming so that not only can clients stream messages to the server, but the service can independently stream messages back to the client. This means that the robot (client) can send events to the brain (server) and the brain can send commands back to the robot without requiring any polling, separate connection back from brain to robot or some custom protocol. I <em>could</em> have opted to just open a <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite">TCP/IP</a> connection or <a href="https://en.wikipedia.org/wiki/WebSocket">websocket</a> and do everything else myself, but why take on additional work if someone else has already done it?</p><h2 id="how-to-define-a-bi-directional-service"><span class="mr-2">How to define a bi-directional service</span><a href="#how-to-define-a-bi-directional-service" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>gRPC supports several types of remote call, all of which can be mixed together in the same service:</p><ul><li>single function call - client sends a single message to the service and gets a single response back<li>client streaming - the client sends a stream of messages to the server and gets a single response back<li>server streaming - the client sends a single message to the server, and gets a stream of messages back<li>bi-directional streaming - the client sends a stream of messages to the server, and the serve sends an independent stream of messages back</ul><p>In all these cases the client has to initiate the request - the server cannot invoke functions on the client.</p><p>We’ll almost certainly want to add more later, but for now let’s define a service that accepts a stream of events from the robot and sends back a stream of actions for the robot to take.</p><p>With the gRPC extensions to protobuf, this service looks like this:</p><div class="language-protobuf highlighter-rouge"><div class="code-header"> <span data-label-text="Protobuf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">service</span> <span class="n">TheSocialRobot</span> <span class="p">{</span>
    <span class="k">rpc</span> <span class="n">EventStream</span><span class="p">(</span><span class="n">stream</span> <span class="n">BodyEvent</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">stream</span> <span class="n">BodyCommand</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The function is called “EventStream”. Its parameters are defined in the brackets after the name and the response, if any, in the brackets after <code class="language-plaintext highlighter-rouge">return</code>. In this case the parameter is a stream of <code class="language-plaintext highlighter-rouge">BodyEvent</code> messages from the client and the response is a stream of <code class="language-plaintext highlighter-rouge">BodyCommand</code> messages from the server.</p><p>We’ll figure out the format for body events later, so for now, they just contain a message ID:</p><div class="language-protobuf highlighter-rouge"><div class="code-header"> <span data-label-text="Protobuf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// event from robot (the body) containing current state</span>
<span class="kd">message</span> <span class="nc">BodyEvent</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Each field in a protobuf message has an integer ID, typically these are incremented by 1 for each field. <code class="language-plaintext highlighter-rouge">BodyEvent</code> has a single field, called “id” with an identifier of 1.</p><p>The commands from the brain are a little more complex. We can imagine that the brain might want the robot to perform a number of actions - for example waving its arm and saying “hello” - so we want a <code class="language-plaintext highlighter-rouge">BodyCommand</code> to contain a sequence of actions and a way to indicate which, if any, should occur at the same time. The simplest way to do this feels like including a delay with each action with zero meaning “do this immediately” and a non-zero positive integer meaning “wait this number of milliseconds”. Actions that should happen at the same time will have the same delay.</p><p>We’re not going to try and define all possible actions right now, so we’ll start with a single action “say” so we can say “Hello World”.</p><div class="language-protobuf highlighter-rouge"><div class="code-header"> <span data-label-text="Protobuf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">message</span> <span class="nc">Say</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="na">text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Action</span> <span class="p">{</span>
    <span class="c1">// delay in milliseconds before triggering the action</span>
    <span class="kt">int32</span> <span class="na">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">oneof</span> <span class="n">action</span> <span class="p">{</span>
        <span class="n">Say</span> <span class="na">say</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// message from brain to body, instructing the body do take one or more actions</span>
<span class="kd">message</span> <span class="nc">BodyCommand</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">repeated</span> <span class="n">Action</span> <span class="na">actions</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We need a bit of boilerplate to indicate what version of protocol buffers we are using so the complete code looks like this:</p><div class="language-protobuf highlighter-rouge"><div class="code-header"> <span data-label-text="Protobuf"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/TheSocialRobot/BrainCore/thesocialrobot"</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">thesocialrobot</span><span class="p">;</span>

<span class="kd">service</span> <span class="n">TheSocialRobot</span> <span class="p">{</span>
    <span class="k">rpc</span> <span class="n">EventStream</span><span class="p">(</span><span class="n">stream</span> <span class="n">BodyEvent</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">stream</span> <span class="n">BodyCommand</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="c1">// event from robot (the body) containing current state</span>
<span class="kd">message</span> <span class="nc">BodyEvent</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Say</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="na">text</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">Action</span> <span class="p">{</span>
    <span class="c1">// delay in milliseconds before triggering the action</span>
    <span class="c1">// could use the Duration type here, but don't think we need nanosecond</span>
    <span class="c1">// precision and the second/nanosecond split complicates things</span>
    <span class="kt">int32</span> <span class="na">delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">oneof</span> <span class="n">action</span> <span class="p">{</span>
        <span class="n">Say</span> <span class="na">say</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// message from brain to body, instructing the body do take one or more actions</span>
<span class="kd">message</span> <span class="nc">BodyCommand</span> <span class="p">{</span>
    <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">repeated</span> <span class="n">Action</span> <span class="na">actions</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="writing-the-server"><span class="mr-2">Writing the server</span><a href="#writing-the-server" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Defining the content of the messages exchanged between body (client) and brain (server) is all very well, but we need code to actually make anything happen. For the server, I’ve chosen to use go (at least initially) due to its performance, relatively simplicity, easy of deployment, community support and because it is one of the supported languages for gRPC.</p><p>If you’re not already set up with go and the protobuf compiler, take a look at: <a href="https://go.dev/doc/install">go install</a>, <a href="https://grpc.io/docs/protoc-installation/">protoc installation</a> and <a href="https://grpc.io/docs/languages/go/quickstart/">gRPC quickstart</a>. For me it was something like this (I already had go set up):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c"># get the protobuf compiler, protoc, for Linux</span>
wget https://github.com/protocolbuffers/protobuf/releases/download/v21.5/protoc-21.5-linux-x86_64.zip

<span class="c"># unpack the zip file and move the protoc command to a convenient directory in your path</span>
<span class="nb">mkdir </span>tmp-protoc <span class="p">;</span>  <span class="nb">cd </span>tmp-protoc
unzip protoc-21.5-linux-x86_64.zip
<span class="nb">mv </span>bin/proto ~/.local/bin 
<span class="nb">cd</span> .. <span class="p">;</span> <span class="nb">rm</span> <span class="nt">-rf</span> tmp-protoc

<span class="c"># install gRPC plugins for go</span>
go <span class="nb">install </span>google.golang.org/protobuf/cmd/protoc-gen-go@v1.28
go <span class="nb">install </span>google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.2
</pre></table></code></div></div><p>Once you’re setup with go and gRPC then you can generate the go code for the service described the protobuf configuration in <a href="https://github.com/TheSocialRobot/BrainCore/pull/2">thesocialrobot/thesocialrobot.proto</a> as follows:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>protoc <span class="nt">--go_out</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--go_opt</span><span class="o">=</span><span class="nv">paths</span><span class="o">=</span>source_relative <span class="nt">--go-grpc_out</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--go-grpc_opt</span><span class="o">=</span><span class="nv">paths</span><span class="o">=</span>source_relative thesocialrobot/thesocialrobot.proto
</pre></table></code></div></div><p>This will generate the following files:</p><ul><li>thesocialrobot.pb.go - go code to serialise/de-serialise the messages defined in the .proto file.<li>thesocialrobot_grpc.pb.go - go client stub code and gRPC server code for the service defined in the .proto file.</ul><p>In go we need to import the generated files:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="n">pb</span> <span class="s">"github.com/TheSocialRobot/BrainCore/thesocialrobot"</span>
</pre></table></code></div></div><p>The generated go code defines an interface that we need to implement in our server. In thesocialrobot_grpc.pb.go:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c">// TheSocialRobotServer is the server API for TheSocialRobot service.</span>
<span class="c">// All implementations must embed UnimplementedTheSocialRobotServer</span>
<span class="c">// for forward compatibility</span>
<span class="k">type</span> <span class="n">TheSocialRobotServer</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">EventStream</span><span class="p">(</span><span class="n">TheSocialRobot_EventStreamServer</span><span class="p">)</span> <span class="kt">error</span>
    <span class="n">mustEmbedUnimplementedTheSocialRobotServer</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We’ve only defined one method in our service, so we just need to implement <code class="language-plaintext highlighter-rouge">EventStream</code> as well as embedding the <code class="language-plaintext highlighter-rouge">UnimplementedTheSocialRobotServer</code> interface to allow for forward compatibility.</p><p>Since go does not require that we explicitly state that we’re implementing an interface we just need to define a struct and implement the EventStream method on it</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">theSocialRobotServer</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">pb</span><span class="o">.</span><span class="n">UnimplementedTheSocialRobotServer</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">theSocialRobotServer</span><span class="p">)</span> <span class="n">EventStream</span><span class="p">(</span><span class="n">stream</span> <span class="n">pb</span><span class="o">.</span><span class="n">TheSocialRobot_EventStreamServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c">// TBD</span>
<span class="p">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">TheSocialRobot_EventStreamServer</code> is a generated type that provides access to the stream of messages from the client, using <code class="language-plaintext highlighter-rouge">stream.Recv()</code>, and allows us to send messages from the server, using <code class="language-plaintext highlighter-rouge">stream.Send()</code>.</p><p>In practice, we’d want to process incoming and outgoing streams independently, but for this “Hello World” example I’m just receiving a message from the client and sending a message back telling the client to say “Hello World” without any delay.</p><p>We first receive a message and check for errors (no exceptions in go):</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Recv</span><span class="p">()</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We don’t care about the contents of the message at the moment, so we ignore it with <code class="language-plaintext highlighter-rouge">_</code>.</p><p>We then need to construct a BodyCommand instance containing a single embedded <code class="language-plaintext highlighter-rouge">Say</code> action:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">command</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">BodyCommand</span><span class="p">{</span>
    <span class="n">Id</span><span class="o">:</span>      <span class="m">1</span><span class="p">,</span>
    <span class="n">Actions</span><span class="o">:</span>  <span class="p">[]</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">Action</span><span class="p">{{</span><span class="n">Delay</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Action_Say</span><span class="p">{</span><span class="n">Say</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Say</span><span class="p">{</span><span class="n">Text</span><span class="o">:</span> <span class="s">"Hello World"</span><span class="p">}}}},</span> 
<span class="p">}</span>
</pre></table></code></div></div><p>and then send it to the client:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">stream</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></table></code></div></div><p>The complete function looks like this:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">theSocialRobotServer</span><span class="p">)</span> <span class="n">EventStream</span><span class="p">(</span><span class="n">stream</span> <span class="n">pb</span><span class="o">.</span><span class="n">TheSocialRobot_EventStreamServer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">{</span>
    <span class="c">// TODO handle events from the client</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Recv</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
            <span class="k">return</span> <span class="no">nil</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">err</span>
        <span class="p">}</span>

        <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Received event, sending one command"</span><span class="p">)</span>
        <span class="c">// respond with a single command</span>
        <span class="c">// TODO eventually we'll decouple receiving events from sending commands</span>
        <span class="n">command</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">BodyCommand</span><span class="p">{</span>
           <span class="n">Id</span><span class="o">:</span>      <span class="m">1</span><span class="p">,</span>
           <span class="n">Actions</span><span class="o">:</span>  <span class="p">[]</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">Action</span><span class="p">{{</span><span class="n">Delay</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Action_Say</span><span class="p">{</span><span class="n">Say</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Say</span><span class="p">{</span><span class="n">Text</span><span class="o">:</span> <span class="s">"Hello World"</span><span class="p">}}}},</span> 
        <span class="p">}</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We now need a way to wire this implementation of EventStream to incoming network requests. First we need to open a socket to listen for connections:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">port</span> <span class="o">:=</span> <span class="m">50051</span> <span class="c">// we'll implement command line arguments leter</span>
<span class="n">lis</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">net</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"localhost:%d"</span><span class="p">,</span> <span class="o">*</span><span class="n">port</span><span class="p">))</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"failed to listen: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We now need to tell gRPC start a server</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="n">opts</span> <span class="p">[]</span><span class="n">grpc</span><span class="o">.</span><span class="n">ServerOption</span>
<span class="n">grpcServer</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">NewServer</span><span class="p">(</span><span class="n">opts</span><span class="o">...</span><span class="p">)</span>
</pre></table></code></div></div><p>We then register our service with the server:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">pb</span><span class="o">.</span><span class="n">RegisterTheSocialRobotServer</span><span class="p">(</span><span class="n">grpcServer</span><span class="p">,</span> <span class="nb">new</span><span class="p">(</span><span class="n">theSocialRobotServer</span><span class="p">))</span>
</pre></table></code></div></div><p>Finally, we give the socket to the gRPC server:</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">grpcServer</span><span class="o">.</span><span class="n">Serve</span><span class="p">(</span><span class="n">lis</span><span class="p">)</span>
</pre></table></code></div></div><h2 id="writing-the-client"><span class="mr-2">Writing the client</span><a href="#writing-the-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The code running on the NAO and Alpha 2 robots will not be go. We’ll use C++ for NAO in order to integrate with the NAOqi SDK. For Alpha 2 we’ll use java or kotlin since Alpha 2 is android based. However, for testing purposes we’ll create a client in go which I’ve called “fake body”.</p><p><code class="language-plaintext highlighter-rouge">protoc</code> created a client stub for us in addition to the server code - in this case an interface called TheSocialRobotClient with one method <code class="language-plaintext highlighter-rouge">EventStream</code>.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">type</span> <span class="n">TheSocialRobotClient</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">EventStream</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">opts</span> <span class="o">...</span><span class="n">grpc</span><span class="o">.</span><span class="n">CallOption</span><span class="p">)</span> <span class="p">(</span><span class="n">TheSocialRobot_EventStreamClient</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Calling <code class="language-plaintext highlighter-rouge">EventStream</code> on this stub will result in the corresponding handler on the server being called.</p><p>Before we can use this client interface we need to create a connection to the server and create an instance of the client.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">var</span> <span class="n">opts</span> <span class="p">[]</span><span class="n">grpc</span><span class="o">.</span><span class="n">DialOption</span>
<span class="n">serverAddr</span> <span class="o">:=</span> <span class="s">"localhost:50051"</span>
<span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">Dial</span><span class="p">(</span><span class="o">*</span><span class="n">serverAddr</span><span class="p">,</span> <span class="n">opts</span><span class="o">...</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"fail to dial: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
<span class="n">client</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">NewTheSocialRobotClient</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</pre></table></code></div></div><p>Now we have a client instance, we can invoke the <code class="language-plaintext highlighter-rouge">EventStream</code> method and get back an interface we can use to stream messages to the server and receive messages back.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
<span class="n">stream</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">EventStream</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In the same way as in the server code we can call <code class="language-plaintext highlighter-rouge">stream.Send()</code> to send a message and <code class="language-plaintext highlighter-rouge">stream.Recv()</code> to receive a message. Receiving <code class="language-plaintext highlighter-rouge">io.EOF</code> as an error means that the other end of the connection has closed the stream - there are no more messages to read.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">in</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Recv</span><span class="p">()</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">waitc</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Since a <code class="language-plaintext highlighter-rouge">BodyCommand</code> from the server can contain multiple actions of different types, we use a type switch to determine what we need to do.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Got message %d"</span><span class="p">,</span> <span class="n">in</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
<span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">in</span><span class="o">.</span><span class="n">Actions</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">op</span> <span class="o">:=</span> <span class="n">action</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="p">(</span><span class="k">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">*</span><span class="n">thesocialrobot</span><span class="o">.</span><span class="n">Action_Say</span><span class="o">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"delay %d, say %s"</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">Delay</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">Say</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Since the simple server above only responds when it receives a message, we now need to give it a kick by sending an event. For now we send only a single event and close the stream.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">event</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">BodyEvent</span><span class="p">{</span><span class="n">Id</span><span class="o">:</span> <span class="m">1</span><span class="p">}</span>
<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">event</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream: stream.Send(%v) failed: %v"</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">stream</span><span class="o">.</span><span class="n">CloseSend</span><span class="p">()</span>
</pre></table></code></div></div><p>In <a href="https://github.com/TheSocialRobot/BrainCore/pull/2">the pull request</a> I’ve packaged the interesting client code into a function that sends a message and uses a channel to wait for a response before completing.</p><div class="language-go highlighter-rouge"><div class="code-header"> <span data-label-text="Go"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="k">func</span> <span class="n">runEventStream</span><span class="p">(</span><span class="n">client</span> <span class="n">pb</span><span class="o">.</span><span class="n">TheSocialRobotClient</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="m">10</span><span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
    <span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>
    <span class="n">stream</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">EventStream</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">waitc</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span>
    <span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="n">in</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Recv</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">==</span> <span class="n">io</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
                <span class="nb">close</span><span class="p">(</span><span class="n">waitc</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"Got message %d"</span><span class="p">,</span> <span class="n">in</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">action</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">in</span><span class="o">.</span><span class="n">Actions</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="n">op</span> <span class="o">:=</span> <span class="n">action</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="p">(</span><span class="k">type</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">*</span><span class="n">thesocialrobot</span><span class="o">.</span><span class="n">Action_Say</span><span class="o">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"delay %d, say %s"</span><span class="p">,</span> <span class="n">action</span><span class="o">.</span><span class="n">Delay</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">Say</span><span class="o">.</span><span class="n">Text</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}()</span>
    <span class="n">event</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">BodyEvent</span><span class="p">{</span><span class="n">Id</span><span class="o">:</span> <span class="m">1</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Send</span><span class="p">(</span><span class="n">event</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"client.EventStream: stream.Send(%v) failed: %v"</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">CloseSend</span><span class="p">()</span>
    <span class="o">&lt;-</span><span class="n">waitc</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="running-the-code"><span class="mr-2">Running the code</span><a href="#running-the-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This will hardly be the most exciting demo. Start the server in one terminal:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>go run core/main.go
</pre></table></code></div></div><p>and the client (fake body) in another terminal:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>go run fake-body/main.go
</pre></table></code></div></div><p>Output: server</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>2022/09/20 17:17:41 Received event, sending one <span class="nb">command</span>
</pre></table></code></div></div><p>Output: client</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>2022/09/20 17:17:41 Got message 1
2022/09/20 17:17:41 delay 0, say Hello World
</pre></table></code></div></div><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We’ve taken a first step, but there is still a long way to go! Conspicuously absent is any form of encrypted transport to protect the privacy of client/server traffic (although the PR does have some code copied from the gRPC <a href="https://github.com/grpc/grpc-go/tree/master/examples/route_guide">route guide</a> example to configure TLS) or authentication. We’ll fix that soon. We also need to set up CI/CD so our code gets built and tested automatically.</p><h2 id="next-steps"><span class="mr-2">Next steps</span><a href="#next-steps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Authentication, encryption, tests and CI/CD are all important, but this is “The Social <strong>Robot</strong>” so it’s about time we got some code running on an actual robot and that’s what we’ll do next.</p></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> All rights reserved by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=How to use bi-directional gRPC in go - The Social Robot&amp;url=https://www.thesocialrobot.org//posts/grpc-brain-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=How to use bi-directional gRPC in go - The Social Robot&amp;u=https://www.thesocialrobot.org//posts/grpc-brain-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://www.thesocialrobot.org//posts/grpc-brain-1/&amp;text=How to use bi-directional gRPC in go - The Social Robot" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/bridging-the-digital-divide-can-humans-and-ais-forge-true-friendships/">Bridging the Digital Divide: Can Humans and AIs Forge True Friendships?</a><li><a href="/posts/chatgpt/">State of the Chatbot - ChatGPT</a><li><a href="/posts/basic-architecture/">Basic Architecture</a><li><a href="/posts/hello-world/">Hello World</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/i-ve-been-doing-the-social-robot-wrong/"><div class="card-body"> <em class="timeago small" data-ts="1729448520" > 2024-10-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>I've been doing the social robot wrong</h3><div class="text-muted small"><p> I’ve been thinking about my lack of progress on The Social Robot project. It occurs to me that it’s been at a standstill because I’ve been finding it very hard to motivate myself. I think that’s be...</p></div></div></a></div><div class="card"> <a href="/posts/empowering-the-bedridden-robots-enable-work-and-social-engagement-from-home/"><div class="card-body"> <em class="timeago small" data-ts="1694893500" > 2023-09-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Empowering the Bedridden: How Robots Are Changing Lives by Enabling Work and Social Engagement</h3><div class="text-muted small"><p> Introduction Imagine being confined to your home, unable to step outside, yet still having the ability to work and socialize as if you were out in the world. This isn’t a futuristic dream; it’s ...</p></div></div></a></div><div class="card"> <a href="/posts/bridging-the-digital-divide-can-humans-and-ais-forge-true-friendships/"><div class="card-body"> <em class="timeago small" data-ts="1682015820" > 2023-04-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Bridging the Digital Divide: Can Humans and AIs Forge True Friendships?</h3><div class="text-muted small"><p> I just finished listening to the Bot Love podcast and that got me wondering: “can it really be possible for a human and AI to be friends?” Asymmetric friendship normally refers to friendships in w...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/kuki/" class="btn btn-outline-primary" prompt="Older"><p>State of the Chatbot - Kuki</p></a> <a href="/posts/grpc-brain-2/" class="btn btn-outline-primary" prompt="Newer"><p>How to create a bi-directional gRPC client in C++</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.thesocialrobot.org//posts/grpc-brain-1/'; this.page.identifier = '/posts/grpc-brain-1/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://thesocialrobot.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/davesnowdon">Dave Snowdon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are copyright of the author and may not be reproduced without permission.">All rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-DSJH283QQW"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-DSJH283QQW'); }); </script>
